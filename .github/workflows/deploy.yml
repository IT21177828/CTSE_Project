name: ðŸš€ Deploy to AKS

on:
  workflow_dispatch:
    inputs:
      build_all:
        description: 'Build all services regardless of changes'
        required: false
        default: 'false'
      bypass_security_scan:
        description: 'Bypass Snyk scan failures and continue build'
        required: false
        default: 'false'
      test_all:
        description: 'Test all projects with Snyk, regardless of changes'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Required for HEAD^ to exist

      - name: ðŸ” Authenticate to ACR
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login "${{ secrets.ACR_LOGIN_SERVER }}" \
            --username "${{ secrets.ACR_USERNAME }}" --password-stdin

      - name: ðŸ”§ Detect Changed Services
        id: detect_changes
        run: |
          changed=""
          if [[ "${{ github.event.inputs.build_all }}" == "true" ]]; then
            echo "âœ… build_all is true. Will build all services."
            echo "changed_services=*" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          for dir in backend/services/*; do
            service=$(basename "$dir")
            if ! git diff --quiet HEAD^ HEAD -- "$dir"; then
              echo "âœ… Changes detected in $service"
              changed+="$service "
            else
              echo "âŒ No changes in $service"
            fi
          done

          echo "changed_services=${changed}" >> "$GITHUB_OUTPUT"

      - name: â˜• Set up Java 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ðŸ”¨ Build Maven Projects (Changed or All)
        run: |
          changed="${{ steps.detect_changes.outputs.changed_services }}"
          echo "ðŸ“¦ Services to build: $changed"

          for dir in backend/services/*; do
            service=$(basename "$dir")
            if [[ "$changed" == "*" ]] || [[ "$changed" == *"$service"* ]]; then
              echo "ðŸ”§ Building Maven project: $service"
              mvn -B clean package -DskipTests -f "$dir/pom.xml"
            fi
          done

      - name: ðŸ§ª Snyk Scan (All or Changed Projects)
        run: |
          npm install -g snyk

          echo "ðŸ” Starting Snyk scan..."
          changed="${{ steps.detect_changes.outputs.changed_services }}"
          test_all="${{ github.event.inputs.test_all }}"
          bypass="${{ github.event.inputs.bypass_security_scan }}"
          result_summary=""
          failed=0

          for dir in backend/services/*; do
            service=$(basename "$dir")

            if [[ "$test_all" == "true" ]] || [[ "$changed" == "*" ]] || [[ "$changed" == *"$service"* ]]; then
              echo "ðŸ§ª Running Snyk scan on $service..."
              if snyk test --file="$dir/pom.xml" --project-name="$service" --policy-path=.snyk; then
                echo "âœ… Snyk scan passed for $service"
                result_summary+="âœ… $service: PASSED\n"
              else
                echo "âŒ Snyk scan FAILED for $service"
                result_summary+="âŒ $service: FAILED\n"
                failed=1
              fi
            else
              echo "â­ï¸ Skipping Snyk scan for $service (not changed)"
            fi
          done

          echo -e "\nðŸ§¾ Snyk Scan Summary:\n$result_summary"

          if [[ "$failed" -eq 1 && "$bypass" != "true" ]]; then
            echo "âŒ One or more Snyk scans failed and bypass_security_scan is false. Failing pipeline."
            exit 1
          else
            echo "âœ… All scans completed. Continuing with pipeline (bypass=${bypass})"
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: ðŸ› ï¸ Build & Push Changed Docker Images
        run: |
          changed="${{ steps.detect_changes.outputs.changed_services }}"
          echo "ðŸ³ Services to build Docker images for: $changed"

          for dir in backend/services/*; do
            service=$(basename "$dir")
            if [[ "$changed" == "*" ]] || [[ "$changed" == *"$service"* ]]; then
              echo "âœ¨ Building and pushing Docker image for $service"
              docker build -t "${{ secrets.ACR_LOGIN_SERVER }}/$service:latest" "$dir"
              docker push "${{ secrets.ACR_LOGIN_SERVER }}/$service:latest"
            fi
          done

      - name: âš™ï¸ Set up kubectl CLI
        uses: azure/setup-kubectl@v3

      - name: ðŸ”§ Configure Kubeconfig for AKS
        run: |
          echo "$KUBECONFIG_DATA" > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          kubectl config get-contexts
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}

      - name: ðŸš¢ Deploy Kubernetes Manifests
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          kubectl apply -f backend/k8s/manifests/infrastucture
          kubectl apply -f backend/k8s/manifests/applications/
