name: ðŸš€ Deploy to AKS

on:
  workflow_dispatch:
    inputs:
      build_all:
        description: 'Build all services regardless of changes'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ” Authenticate to ACR
        run: |
          echo ${{ secrets.ACR_PASSWORD }} | docker login ${{ secrets.ACR_LOGIN_SERVER }} \
            --username ${{ secrets.ACR_USERNAME }} --password-stdin

      - name: ðŸ”§ Detect Changed Services
        id: detect_changes
        run: |
          echo "changed_services=" >> $GITHUB_OUTPUT
          if [[ '${{ github.event.inputs.build_all }}' == 'true' ]]; then
            echo "âœ… build_all is set to true. Will build all services."
            echo "changed_services=*" >> $GITHUB_OUTPUT
            exit 0
          fi

          for dir in backend/services/*; do
            service=$(basename "$dir")
            if git diff --quiet HEAD^ HEAD -- "$dir"; then
              echo "âŒ No changes in $service"
            else
              echo "âœ… Changes detected in $service"
              echo "changed_services=$service" >> $GITHUB_OUTPUT
              break
            fi
          done

      - name: â˜• Set up Java 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ðŸ”¨ Build Maven Projects (Changed or All)
        if: steps.detect_changes.outputs.changed_services != ''
        run: |
          for dir in backend/services/*; do
            service=$(basename "$dir")
            if [[ "${{ github.event.inputs.build_all }}" == "true" ]] || \
               git diff --quiet HEAD^ HEAD -- "$dir" == false; then
              echo "ðŸ”§ Building Maven project: $service"
              mvn -B clean package -DskipTests -f "$dir/pom.xml"
            fi
          done

      - name: ðŸ› ï¸ Build & Push Changed Docker Images
        if: steps.detect_changes.outputs.changed_services != ''
        run: |
          for dir in backend/services/*; do
            service=$(basename "$dir")
            if [[ "${{ github.event.inputs.build_all }}" == "true" ]] || \
               git diff --quiet HEAD^ HEAD -- "$dir" == false; then
              echo "âœ¨ Building and pushing $service"
              docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest "$dir"
              docker push ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest
            fi
          done

      - name: âš™ï¸ Set up kubectl CLI
        uses: azure/setup-kubectl@v3

      - name: ðŸ”§ Configure Kubeconfig for AKS
        run: |
          echo "$KUBECONFIG_DATA" > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          kubectl config get-contexts
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}

      - name: ðŸš¢ Deploy Kubernetes Manifests
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          kubectl apply -f backend/k8s/manifests/infrastucture
          kubectl apply -f backend/k8s/manifests/applications/